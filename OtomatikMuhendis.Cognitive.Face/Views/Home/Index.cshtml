@{
    ViewData["Title"] = "Emotions to emoticons";
}

<h3>How do you feel today?</h3>

<canvas id="canvas" width="800" height="600" style="display:none;"></canvas>

<div id="wrap_video">
    <div id="video_box">
        <div id="video_overlays"><img src="~/asset/smileys/neutral.png" id="imgResult" /></div>
        <div>
            <video width=800 height=600 id="video" controls autoplay></video>
        </div>
    </div>
</div>


@section Scripts{
    <script>
        //--------------------
        // GET USER MEDIA CODE
        //--------------------
        navigator.getUserMedia = (navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia);

        var video;
        var webcamStream;

        function startWebcam() {
            if (navigator.getUserMedia) {
                navigator.getUserMedia(

                    // constraints
                    {
                        video: true,
                        audio: false
                    },

                    // successCallback
                    function (localMediaStream) {
                        video = document.querySelector('video');

                        if (window.webkitURL) {
                            video.srcObject = localMediaStream;
                        } else {
                            video.src = stream;
                        }

                        webcamStream = localMediaStream;
                    },

                    // errorCallback
                    function (err) {
                        console.log("The following error occured: " + err);
                    }
                );
            } else {
                console.log("getUserMedia not supported");
            }

            setInterval(sendToServer, 1000);
        }

        var canvas, ctx;

        function init() {
            // Get the canvas and obtain a context for
            // drawing in it
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext('2d');

            startWebcam();
        }

        function snapshot() {
            // Draws current image from the video element into the canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }

        document.addEventListener("DOMContentLoaded", init);

        function sendToServer() {
            snapshot();

            var image = document.getElementById("canvas").toDataURL("image/png");
            image = image.replace('data:image/png;base64,', '');
            $.ajax({
                type: 'POST',
                url: '/Home/Face',
                data: '{ "imageData" : "' + image + '" }',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {
                    if (data) {
                        var maxValue = 0;
                        var maxName = 'neutral';
                        $.each(data, function (i, n) {
                            if (n > maxValue) {
                                maxValue = n;
                                maxName = i;
                            }
                        });

                        if (data.anger > 0.5) {
                            maxName = 'anger';
                        }

                        $("#imgResult").attr("src", "/asset/smileys/" + maxName + ".png");

                        console.log(JSON.stringify(data));
                    }
                }
            });
        }
    </script>
}
